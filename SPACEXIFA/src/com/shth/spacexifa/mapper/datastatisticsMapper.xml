<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shth.spacexifa.dao.DataStatisticsMapper">

    <resultMap id="dataMap" type="com.shth.spacexifa.model.DataStatistics">
        <id property="id" column="fid"></id>
        <result property="name" column="fname"></result>
        <result property="insid" column="insid"></result>
        <result property="insname" column="insname"></result>
        <result property="total" column="total"></result>
        <result property="num" column="num"></result>
        <result property="gas" column="gas"></result>
        <result property="weldwire" column="weldwire"></result>
        <result property="machinenum" column="machinenum"></result>
        <result property="junctionnum" column="junctionnum"></result>
        <result property="worktime" column="worktime"></result>
        <result property="wireweight" column="fwire_weight"></result>
        <result property="speed" column="fspeed"></result>
        <result property="airflow" column="fair_flow_volume"></result>
        <result property="standbypower" column="fstandby_power"></result>
        <result property="electricity" column="electricity"></result>
        <result property="voltage" column="voltage"></result>
        <result property="serialnumber" column="serialnumber"></result>
        <result property="valuename" column="fvaluename"></result>
        <result property="time" column="time"></result>
        <result property="welderno" column="welderno"></result>
        <result property="hour" column="hour"></result>
        <result property="taskid" column="ftaskid"></result>
        <result property="taskno" column="fjunction_no"></result>
        <result property="welderid" column="fwelderid"></result>
        <result property="weldername" column="weldername"></result>
        <result property="machineid" column="fmachineid"></result>
        <result property="machineno" column="fequipment_no"></result>
        <result property="starttime" column="frealstarttime"></result>
        <result property="endtime" column="frealendtime"></result>
        <result property="channel" column="fchannel"></result>
        <result property="type" column="type"></result>
        <result property="wirefeedrate" column="wirefeedrate"></result>
        <result property="wkhour" column="wkhour"></result>
        <result property="wnhour" column="wnhour"></result>
        <result property="JOB_NUMBER" column="JOB_NUMBER"></result>
        <result property="SET_NUMBER" column="SET_NUMBER"></result>
        <result property="PART_NAME" column="PART_NAME"></result>
    </resultMap>

    <select id="getTaskDetail" resultMap="dataMap">
        select ftaskid,fwelderid,fmachineid,fname,fwelder_no welderno,weldername,fequipment_no,fwelded_junction_no
        fjunction_no, frealstarttime,frealendtime,
        fchannel,felectricity electricity,fvoltage voltage,sum(alarmtime)+sum(warntime)
        warntime,sum(worktime)-sum(alarmtime) worktime
        from (
        select t.ftaskid,t.fwelderid,t.fmachineid, i.fname,w.fwelder_no,w.fname weldername,m.fequipment_no,
        j.fwelded_junction_no,t.frealstarttime,
        t.frealendtime,fchannel,avg(felectricity) felectricity, AVG(fvoltage) fvoltage,0 alarmtime,0 warntime
        ,sum(tw.fworktime) worktime from tb_taskresult t
        left JOIN tb_welder w on w.fid = t.fwelderid left join tb_welding_machine m on m.fid = t.fmachineid
        left JOIN tb_work tw on tw.fwelder_id = t.fwelderid and tw.fmachine_id = t.fmachineid and tw.fjunction_id =
        t.ftaskid
        left JOIN tb_welded_junction j on j.fid= t.ftaskid
        LEFT JOIN tb_insframework i on i.fid = tw.fjunction_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent where 1=1
        <if test="parent!=null and parent!=''">
            and (i.fid=#{parent} or ins.fid=#{parent} or insf.fid=#{parent} or insf.fparent=#{parent})
        </if>
        <if test="welderno!=null and welderno!=''">
            and w.fwelder_no like ${welderno}
        </if>
        <if test="taskno!=null and taskno!=''">
            and fwelded_junction_no like ${taskno}
        </if>
        <if test="dtoTime1!=null and dtoTime1!=''">
            and frealstarttime &gt;= #{dtoTime1}
        </if>
        <if test="dtoTime2!=null and dtoTime2!=''">
            and (frealendtime &lt;= #{dtoTime2} or frealendtime is null)
        </if>
        group by
        t.ftaskid,t.fwelderid,t.fmachineid,i.fname,w.fwelder_no,w.fname,m.fequipment_no,j.fwelded_junction_no,t.frealstarttime,
        t.frealendtime,fchannel
        <!-- UNION ALL
        select t.ftaskid,t.fwelderid,t.fmachineid, i.fname,w.fwelder_no,w.fname weldername,m.fequipment_no, j.fwelded_junction_no,t.frealstarttime,
        t.frealendtime,fchannel,avg(felectricity) felectricity, AVG(fvoltage) fvoltage,sum(tw.falarmtime) alarmtime,0 warntime ,0 worktime from tb_taskresult t
        left JOIN tb_welder w on w.fid = t.fwelderid left join tb_welding_machine m on m.fid = t.fmachineid
        left JOIN tb_alarm tw on tw.fwelder_id = t.fwelderid and tw.fmachine_id = t.fmachineid and tw.fjunction_id = t.ftaskid
        left JOIN tb_welded_junction j on j.fid= t.ftaskid
        LEFT JOIN tb_insframework i on i.fid = tw.fjunction_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent where 1=1
        <if test="parent!=null and parent!=''">
            and (i.fid=#{parent} or ins.fid=#{parent} or insf.fid=#{parent} or insf.fparent=#{parent})
        </if>
        <if test="welderno!=null and welderno!=''">
            and w.fwelder_no like ${welderno}
        </if>
        <if test="taskno!=null and taskno!=''">
            and fwelded_junction_no like ${taskno}
        </if>
        <if test="dtoTime1!=null and dtoTime1!=''">
            and frealstarttime &gt;= #{dtoTime1}
        </if>
        <if test="dtoTime2!=null and dtoTime2!=''">
            and (frealendtime &lt;= #{dtoTime2}  or frealendtime is null)
        </if> group by t.ftaskid,t.fwelderid,t.fmachineid -->
        UNION ALL
        select t.ftaskid,t.fwelderid,t.fmachineid, i.fname,w.fwelder_no,w.fname weldername,m.fequipment_no,
        j.fwelded_junction_no,t.frealstarttime,
        t.frealendtime,fchannel,avg(felectricity) felectricity, AVG(fvoltage) fvoltage,0 alarmtime,sum(tw.fwarntime)
        warntime ,0 worktime from tb_taskresult t
        left JOIN tb_welder w on w.fid = t.fwelderid left join tb_welding_machine m on m.fid = t.fmachineid
        left JOIN tb_warn tw on tw.fwelder_id = t.fwelderid and tw.fmachine_id = t.fmachineid and tw.fjunction_id =
        t.ftaskid
        left JOIN tb_welded_junction j on j.fid= t.ftaskid
        LEFT JOIN tb_insframework i on i.fid = tw.fjunction_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent where 1=1
        <if test="parent!=null and parent!=''">
            and (i.fid=#{parent} or ins.fid=#{parent} or insf.fid=#{parent} or insf.fparent=#{parent})
        </if>
        <if test="welderno!=null and welderno!=''">
            and w.fwelder_no like ${welderno}
        </if>
        <if test="taskno!=null and taskno!=''">
            and fwelded_junction_no like ${taskno}
        </if>
        <if test="dtoTime1!=null and dtoTime1!=''">
            and frealstarttime &gt;= #{dtoTime1}
        </if>
        <if test="dtoTime2!=null and dtoTime2!=''">
            and (frealendtime &lt;= #{dtoTime2} or frealendtime is null)
        </if>
        group by
        t.ftaskid,t.fwelderid,t.fmachineid,i.fname,w.fwelder_no,w.fname,m.fequipment_no,j.fwelded_junction_no,t.frealstarttime,
        t.frealendtime,fchannel
        )
        temp group by ftaskid,fwelderid,fmachineid,fname,fwelder_no, weldername,fequipment_no,
        fwelded_junction_no,frealstarttime,frealendtime,fchannel,felectricity,fvoltage
    </select>

    <select id="getTask" resultMap="dataMap">
        select ftaskid,fwelderid,fmachineid,frealstarttime,frealendtime,foperatetype type,i.fid,
        i.fname,w.fwelder_no welderno,w.fname weldername,j.fwelded_junction_no fjunction_no,m.fequipment_no from
        tb_taskresult t
        LEFT JOIN tb_welding_machine m on m.fid = t.fmachineid
        LEFT JOIN tb_welder w on w.fid = t.fwelderid
        LEFT JOIN tb_welded_junction j on j.fid = t.ftaskid
        LEFT JOIN tb_insframework i on i.fid = j.fitemId left JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="parent!=null and parent!=''">
            and (i.fid=#{parent} or ins.fid=#{parent} or insf.fid=#{parent} or insf.fparent=#{parent})
        </if>
        <if test="welderno!=null and welderno!=''">
            and w.fwelder_no like ${welderno}
        </if>
        <if test="taskno!=null and taskno!=''">
            and j.fwelded_junction_no like ${taskno}
        </if>
        <if test="dtoTime1!=null and dtoTime1!=''">
            and frealstarttime &gt;= #{dtoTime1}
        </if>
        <if test="dtoTime2!=null and dtoTime2!=''">
            and (frealendtime &lt;= #{dtoTime2} or frealendtime is null)
        </if>
        <!--group by t.ftaskid,t.fwelderid,t.fmachineid-->
        group by ftaskid,fwelderid,fmachineid,frealstarttime,frealendtime,foperatetype ,i.fid,
        i.fname,w.fwelder_no,w.fname ,j.fwelded_junction_no,m.fequipment_no
        order by ftaskid,frealstarttime,frealendtime
    </select>

    <!-- 获取项目部焊机总数 -->
    <select id="getItemMachineCount" resultMap="dataMap">
        <!--		select * from (-->
        <!--		select i.fid,i.fname,count(w.fid) total from tb_insframework i -->
        <!--		inner join tb_welding_machine w on w.finsframework_id=i.fid -->
        <!--		left JOIN tb_insframework ins on ins.fid = i.fparent-->
        <!--        left JOIN tb_insframework insf on insf.fid = ins.fparent-->
        <!--		where i.ftype=23 -->
        <!--		<if test="parent!=null and parent!=''">-->
        <!--			and (i.fid=#{parent} or ins.fid=#{parent} or insf.fid=#{parent} or insf.fparent=#{parent})-->
        <!--		</if>-->
        <!--		group by i.fid,i.fname-->
        <!--		UNION ALL-->
        <!--		select i.fid,i.fname,0 total from tb_insframework  i -->
        <!--		left JOIN tb_insframework ins on ins.fid = i.fparent-->
        <!--        left JOIN tb_insframework insf on insf.fid = ins.fparent-->
        <!--		where i.ftype=23 -->
        <!--		<if test="parent!=null and parent!=''">-->
        <!--			and (i.fid=#{parent} or ins.fid=#{parent} or insf.fid=#{parent} or insf.fparent=#{parent})-->
        <!--		</if>-->
        <!--		and i.fid not in -->
        <!--		(select i.fid from tb_insframework i -->
        <!--		inner join tb_welding_machine w on w.finsframework_id=i.fid -->
        <!--		left JOIN tb_insframework ins on ins.fid = i.fparent-->
        <!--        left JOIN tb_insframework insf on insf.fid = ins.fparent-->
        <!--		where i.ftype=23 -->
        <!--		<if test="parent!=null and parent!=''">-->
        <!--			and (i.fid=#{parent} or ins.fid=#{parent} or insf.fid=#{parent} or insf.fparent=#{parent})-->
        <!--		</if>-->
        <!--		 group by i.fid )-->
        <!--		)temp order by fid-->
        SELECT i.fid,i.fname,count(w.fid) total FROM tb_insframework i
        LEFT JOIN tb_welding_machine w ON w.finsframework_id=i.fid
        LEFT JOIN tb_insframework ins ON ins.fid = i.fparent
        LEFT JOIN tb_insframework insf ON insf.fid = ins.fparent
        WHERE i.FTYPE = 23
        <if test="parent!=null and parent!=''">
            and (i.fid=#{parent} or ins.fid=#{parent} or insf.fid=#{parent} or insf.fparent=#{parent})
        </if>
        GROUP BY i.fid,i.fname
    </select>

    <select id="getItemMachineByItemType" resultMap="dataMap" parameterType="int">
        <!-- 22:工区，23：班组 -->
        <if test="itemtype == 22">
            SELECT i.fid,i.fname,sum(t.total) total,sum(t.FSTANDBYTIME) standbytime,sum(t.fworktime)
            worktime,sum(t.electricity) electricity,sum(t.voltage) voltage FROM tb_insframework i
            INNER JOIN(
            SELECT i.fid,i.fname,count(DISTINCT w.fid) total,i.FPARENT,sum(DISTINCT s.FSTANDBYTIME)
            FSTANDBYTIME,sum(DISTINCT wk.fworktime) fworktime,avg(wk.felectricity) electricity,
            avg(wk.fvoltage) voltage FROM tb_insframework i
            LEFT JOIN tb_welding_machine w ON w.finsframework_id = i.fid
            LEFT JOIN tb_standby s ON s.FMACHINE_ITEMID = i.fid
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and s.fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            LEFT JOIN tb_work wk ON wk.FMACHINE_ITEMID = i.fid
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and wk.fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            WHERE i.FTYPE = 23
            GROUP BY i.fid,i.fname,i.FPARENT ORDER BY FID
            )t ON t.FPARENT = i.fid
            WHERE i.FTYPE = 22 GROUP BY i.fid,i.fname ORDER BY FID
        </if>
        <if test="itemtype == 23">
            SELECT i.fid,i.fname,count(DISTINCT w.fid) total,i.FPARENT,sum(DISTINCT s.FSTANDBYTIME)
            standbytime,sum(DISTINCT wk.fworktime) worktime,avg(wk.felectricity) electricity,
            avg(wk.fvoltage) voltage FROM tb_insframework i
            LEFT JOIN tb_welding_machine w ON w.finsframework_id = i.fid
            LEFT JOIN tb_standby s ON s.FMACHINE_ITEMID = i.fid
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and s.fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            LEFT JOIN tb_work wk ON wk.FMACHINE_ITEMID = i.fid
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and wk.fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            WHERE i.FTYPE = 23
            GROUP BY i.fid,i.fname,i.FPARENT ORDER BY FID
        </if>
    </select>

    <select id="getMachineRadio" resultMap="dataMap" parameterType="int">
        <!-- 22:工区，23：班组 -->
        <if test="itemtype == 22">
            SELECT i.fid,i.fname,sum(t.total) total,sum(t.hour) hour,sum(t.num) num FROM tb_insframework i
            INNER JOIN(
            SELECT i.fid,i.fname,count(DISTINCT w.fid) total,i.FPARENT,COUNT(DISTINCT s.FMACHINE_ID) hour,COUNT(DISTINCT
            wk.FMACHINE_ID) num FROM tb_insframework i
            LEFT JOIN tb_welding_machine w ON w.finsframework_id = i.fid
            LEFT JOIN tb_standby s ON s.FMACHINE_ITEMID = i.fid
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and s.fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            LEFT JOIN tb_work wk ON wk.FMACHINE_ITEMID = i.fid
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and wk.fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            WHERE i.FTYPE = 23
            GROUP BY i.fid,i.fname,i.FPARENT ORDER BY FID
            )t ON t.FPARENT = i.fid
            WHERE i.FTYPE = 22 GROUP BY i.fid,i.fname ORDER BY FID
        </if>
        <if test="itemtype == 23">
            SELECT i.fid,i.fname,count(DISTINCT w.fid) total,i.FPARENT,COUNT(DISTINCT s.FMACHINE_ID) hour,COUNT(DISTINCT
            wk.FMACHINE_ID) num FROM tb_insframework i
            LEFT JOIN tb_welding_machine w ON w.finsframework_id = i.fid
            LEFT JOIN tb_standby s ON s.FMACHINE_ITEMID = i.fid
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and s.fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            LEFT JOIN tb_work wk ON wk.FMACHINE_ITEMID = i.fid
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and wk.fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            WHERE i.FTYPE = 23
            GROUP BY i.fid,i.fname,i.FPARENT ORDER BY FID
        </if>
    </select>


    <!-- 获取开机焊机数 -->
    <select id="getStartingUpMachineNum" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT FMACHINE_ID) num FROM tb_standby
        WHERE 1 = 1
        <if test="itemid != null and itemid != ''">
            AND fmachine_itemid = #{itemid}
        </if>
        <if test="dto != null and dto != ''">
            <if test="dto.dtoTime1 != null and dto.dtoTime1 != ''">
                AND FSTARTTIME >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        <!--        select count(*) from(-->
        <!--        select fmachine_id from tb_work w-->
        <!--        INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid left JOIN tb_insframework ins on ins.fid = i.fparent-->
        <!--        left JOIN tb_insframework insf on insf.fid = ins.fparent-->
        <!--        where fmachine_id!=0-->
        <!--        <if test="itemid!=null and itemid!=''">-->
        <!--            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})-->
        <!--        </if>-->
        <!--        <if test="dto!=null and dto!=''">-->
        <!--            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">-->
        <!--                and fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')-->
        <!--            </if>-->
        <!--            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">-->
        <!--                and to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss') >= fendtime-->
        <!--            </if>-->
        <!--        </if>-->
        <!--        UNION-->
        <!--        select fmachine_id from tb_standby w-->
        <!--        INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid left JOIN tb_insframework ins on ins.fid = i.fparent-->
        <!--        left JOIN tb_insframework insf on insf.fid = ins.fparent-->
        <!--        where fmachine_id!=0-->
        <!--        <if test="itemid!=null and itemid!=''">-->
        <!--            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})-->
        <!--        </if>-->
        <!--        <if test="dto!=null and dto!=''">-->
        <!--            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">-->
        <!--                and fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')-->
        <!--            </if>-->
        <!--            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">-->
        <!--                and to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss') >= fendtime-->
        <!--            </if>-->
        <!--        </if>-->
        <!--        UNION-->
        <!--        select fmachine_id from tb_warn w-->
        <!--        INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid left JOIN tb_insframework ins on ins.fid = i.fparent-->
        <!--        left JOIN tb_insframework insf on insf.fid = ins.fparent-->
        <!--        where fmachine_id!=0-->
        <!--        <if test="itemid!=null and itemid!=''">-->
        <!--            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})-->
        <!--        </if>-->
        <!--        <if test="dto!=null and dto!=''">-->
        <!--            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">-->
        <!--                and fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')-->
        <!--            </if>-->
        <!--            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">-->
        <!--                and to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss') >= fendtime-->
        <!--            </if>-->
        <!--        </if>-->
        <!--        )temp-->
    </select>

    <!-- 获取工作的焊机数-->
    <select id="getWorkMachineNum" resultMap="dataMap">
        select count(DISTINCT(fmachine_id)) machinenum
        from tb_work w
        INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where fmachine_id!=0
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss') >= fendtime
            </if>
        </if>
    </select>

    <!-- 获取工作的焊口数-->
    <select id="getWorkJunctionNum" resultMap="dataMap">
        select count(fjunction_id) junctionnum from(
        select fjunction_id from tb_work w
        INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where fjunction_id != 0
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.machineid!=null and dto.machineid!=''">
                and fmachine_id = #{dto.machineid}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss') >= fendtime
            </if>
        </if>
        union
        select fjunction_id from tb_standby w
        INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where fjunction_id != 0
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.machineid!=null and dto.machineid!=''">
                and fmachine_id = #{dto.machineid}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss') >= fendtime
            </if>
        </if>
        )temp
    </select>


    <!-- 获取工作的焊口数-->
    <select id="getWorkJunctionNumByWelder" resultMap="dataMap">
        select count(fjunction_id) junctionnum from(
        select fjunction_id from tb_work w
        INNER JOIN tb_insframework i on i.fid = w.fwelder_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where fjunction_id != 0
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.welderno!=null and dto.welderno!=''">
                and fwelder_no = #{dto.welderno}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        union
        select fjunction_id from tb_standby w
        INNER JOIN tb_insframework i on i.fid = w.fwelder_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where fjunction_id != 0
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.welderno!=null and dto.welderno!=''">
                and fwelder_no = #{dto.welderno}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        )temp
    </select>

    <!-- 获取开机总时长 -->
    <select id="getStaringUpTime" resultType="java.math.BigInteger">
        select sum(num) from(
        select sum(fworktime) num from tb_work w INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid left JOIN
        tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.machineid!=null and dto.machineid!=''">
                and fmachine_id = #{dto.machineid}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss') >= fendtime
            </if>
        </if>
        UNION ALL
        select sum(fstandbytime) num from tb_standby w INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid left
        JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.machineid!=null and dto.machineid!=''">
                and fmachine_id = #{dto.machineid}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss') >= fendtime
            </if>
        </if>
        UNION ALL
        select sum(fwarntime) num from tb_warn w INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid left JOIN
        tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where w.fstatus !=99
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.machineid!=null and dto.machineid!=''">
                and fmachine_id = #{dto.machineid}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss') >= fendtime
            </if>
        </if>
        )temp
    </select>

    <!-- 获取焊缝工作时长-->
    <select id="getWorkingJunction" resultType="java.math.BigInteger">
        select sum(num) from(
        select sum(fworktime) num from tb_work w
        where 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.junctionid!=null and dto.junctionid!=''">
                and fjunction_id = #{dto.junctionid}
            </if>
            <if test="dto.bloc!=null and dto.bloc!=''">
                and w.FPRODUCT_NUMBER_ID = #{dto.bloc}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        UNION ALL
        select sum(fstandbytime) num from tb_standby w
        where 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.junctionid!=null and dto.junctionid!=''">
                and fjunction_id = #{dto.junctionid}
            </if>
            <if test="dto.bloc!=null and dto.bloc!=''">
                and w.FPRODUCT_NUMBER_ID = #{dto.bloc}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        UNION ALL
        select sum(fwarntime) num from tb_warn w
        where w.fstatus !=99
        <if test="dto!=null and dto!=''">
            <if test="dto.junctionid!=null and dto.junctionid!=''">
                and fjunction_id = #{dto.junctionid}
            </if>
            <if test="dto.bloc!=null and dto.bloc!=''">
                and w.FPRODUCT_NUMBER_ID = #{dto.bloc}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        )temp
    </select>

    <!-- 工件焊接时长及平均电流电压 -->
    <select id="getEleVolByJunction" resultMap="dataMap">
        SELECT sum(electricity) electricity,sum(voltage) voltage,sum(worktime) worktime,sum(time) time from (
        select avg(felectricity) electricity,avg(fvoltage) voltage,sum(fworktime) worktime,0 time from tb_work w
        where 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.junctionid!=null and dto.junctionid!=''">
                and fjunction_id = #{dto.junctionid}
            </if>
            <if test="dto.bloc!=null and dto.bloc!=''">
                and w.FPRODUCT_NUMBER_ID = #{dto.bloc}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        union all
        select 0 electricity,0 voltage,0 worktime,sum(falarmtime) time from tb_alarm w
        where 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.junctionid!=null and dto.junctionid!=''">
                and fjunction_id = #{dto.junctionid}
            </if>
            <if test="dto.bloc!=null and dto.bloc!=''">
                and w.FPRODUCT_NUMBER_ID = #{dto.bloc}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        )temp
    </select>

    <!-- 工件待机时长 -->
    <select id="getStandJunction" resultType="java.math.BigInteger">
        select sum(fstandbytime) worktime from tb_standby w
        where 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.junctionid!=null and dto.junctionid!=''">
                and fjunction_id = #{dto.junctionid}
            </if>
            <if test="dto.bloc!=null and dto.bloc!=''">
                and w.FPRODUCT_NUMBER_ID = #{dto.bloc}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
    </select>

    <!-- 获取开机总时长 -->
    <select id="getStaringUpTimeByJunction" resultType="java.math.BigInteger">
        select sum(num) from(
        select sum(fworktime) num from tb_work w INNER JOIN tb_insframework i on i.fid = w.fjunction_itemid left JOIN
        tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.junctionno!=null and dto.junctionno!=''">
                and fjunction_no = #{dto.junctionno}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        UNION ALL
        select sum(fstandbytime) num from tb_standby w INNER JOIN tb_insframework i on i.fid = w.fjunction_itemid left
        JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.junctionno!=null and dto.junctionno!=''">
                and fjunction_no = #{dto.junctionno}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        UNION ALL
        select sum(fwarntime) num from tb_warn w INNER JOIN tb_insframework i on i.fid = w.fjunction_itemid left JOIN
        tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where w.fstatus !=99
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.junctionno!=null and dto.junctionno!=''">
                and fjunction_no = #{dto.junctionno}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        )temp
    </select>

    <!-- 获取开机总时长 -->
    <select id="getStaringUpTimeByWelder" resultType="java.math.BigInteger">
        select sum(num) from(
        select sum(fworktime) num from tb_work w INNER JOIN tb_insframework i on i.fid = w.fwelder_itemid left JOIN
        tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.personid!=null and dto.personid!=''">
                and fwelder_id = #{dto.personid}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        UNION ALL
        select sum(fstandbytime) num from tb_standby w INNER JOIN tb_insframework i on i.fid = w.fwelder_itemid left
        JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.personid!=null and dto.personid!=''">
                and fwelder_id = #{dto.personid}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        UNION ALL
        select sum(fwarntime) num from tb_warn w INNER JOIN tb_insframework i on i.fid = w.fjunction_itemid left JOIN
        tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where w.fstatus !=99
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.personid!=null and dto.personid!=''">
                and fwelder_id = #{dto.personid}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        )temp
    </select>

    <!-- 获取焊丝重量，送丝速度，气流量，待机功率-->
    <select id="getParameter" resultMap="dataMap">
        SELECT fwire_weight, fspeed, fair_flow_volume, fstandby_power
        from tb_parameter
    </select>

    <!-- 待机时长 -->
    <select id="getStandytime" resultType="java.math.BigInteger">
        select sum(fstandbytime) worktime from tb_standby w
        INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.machineid!=null and dto.machineid!=''">
                and fmachine_id = #{dto.machineid}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss') >= fendtime
            </if>
        </if>
    </select>


    <!-- 待机时长 -->
    <select id="getStandytimeByWelder" resultType="java.math.BigInteger">
        select sum(fstandbytime) worktime from tb_standby w
        INNER JOIN tb_insframework i on i.fid = w.fwelder_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.personid!=null and dto.personid!=''">
                and fwelder_id = #{dto.personid}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
    </select>


    <!-- 待机时长 -->
    <select id="getStandytimeByJunction" resultType="java.math.BigInteger">
        select sum(fstandbytime) worktime from tb_standby w
        INNER JOIN tb_insframework i on i.fid = w.fjunction_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.junctionno!=null and dto.junctionno!=''">
                and fjunction_no = #{dto.junctionno}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
    </select>

    <!-- 焊接时长及平均电流电压 -->
    <select id="getWorkTimeAndEleVol" resultMap="dataMap">
        SELECT avg(felectricity) electricity,avg(fvoltage) voltage,sum(fworktime) worktime,
        <!-- 焊接时长（s） * 送丝速度（m/min） * 系数值（g/m）= 重量（g） -->
        sum((w.fworktime*w.fwirefeedrate*m.fcoefficient)/60) wirefeedrate
        FROM tb_work w
        LEFT JOIN tb_material_coefficient m on w.fmaterialgas = m.fmaterial and w.fwirediameter = m.fdiameter and
        w.fmachinemodel=m.fmodel
        WHERE 1=1
        <if test="itemid != null and itemid != ''">
            AND w.FMACHINE_ITEMID = #{itemid}
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                AND w.FSTARTTIME >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        <!--        SELECT * from (-->
        <!--        select avg(felectricity) electricity,avg(fvoltage) voltage,sum(fworktime) worktime from tb_work w-->
        <!--        INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid left JOIN tb_insframework ins on ins.fid = i.fparent-->
        <!--        left JOIN tb_insframework insf on insf.fid = ins.fparent-->
        <!--        where 1=1-->
        <!--        <if test="itemid!=null and itemid!=''">-->
        <!--            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})-->
        <!--        </if>-->
        <!--        <if test="dto!=null and dto!=''">-->
        <!--            <if test="dto.machineid!=null and dto.machineid!=''">-->
        <!--                and fmachine_id = #{dto.machineid}-->
        <!--            </if>-->
        <!--            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">-->
        <!--                and fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')-->
        <!--            </if>-->
        <!--            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">-->
        <!--                and to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss') >= fendtime-->
        <!--            </if>-->
        <!--        </if>-->
        <!--        )temp-->
    </select>

    <!-- 焊接时长及平均电流电压 -->
    <select id="getWorkTimeAndEleVolByWelder" resultMap="dataMap">
        SELECT sum(electricity) electricity,sum(voltage) voltage,sum(worktime) worktime,sum(wirefeedrate) wirefeedrate,sum(time) time from (
        select avg(felectricity) electricity,avg(fvoltage) voltage,sum(fworktime) worktime,sum((w.fworktime*w.fwirefeedrate*m.fcoefficient)/60) wirefeedrate,0 time from tb_work w
        INNER JOIN tb_insframework i on i.fid = w.fwelder_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        LEFT JOIN tb_material_coefficient m on w.fmaterialgas = m.fmaterial and w.fwirediameter = m.fdiameter and w.fmachinemodel=m.fmodel
        where 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.personid!=null and dto.personid!=''">
                and fwelder_id = #{dto.personid}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        union all
        select 0 electricity,0 voltage,0 worktime,sum((w.falarmtime*w.fwirefeedrate*m.fcoefficient)/60) wirefeedrate,sum(falarmtime) time from tb_alarm w
        INNER JOIN tb_insframework i on i.fid = w.fwelder_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        LEFT JOIN tb_material_coefficient m on w.fmaterialgas = m.fmaterial and w.fwirediameter = m.fdiameter and w.fmachinemodel=m.fmodel
        where 1=1 and fstatus=99
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.personid!=null and dto.personid!=''">
                and fwelder_id = #{dto.personid}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        )temp
    </select>

    <!-- 焊接时长及平均电流电压 -->
    <select id="getWorkTimeAndEleVolByJunction" resultMap="dataMap">
        SELECT sum(electricity) electricity,sum(voltage) voltage,sum(worktime) worktime,sum(time) time from (
        select avg(felectricity) electricity,avg(fvoltage) voltage,sum(fworktime) worktime,0 time from tb_work w
        INNER JOIN tb_insframework i on i.fid = w.fjunction_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.junctionno!=null and dto.junctionno!=''">
                and fjunction_no = #{dto.junctionno}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        union all
        select 0 electricity,0 voltage,0 worktime,sum(falarmtime) time from tb_alarm w
        INNER JOIN tb_insframework i on i.fid = w.fjunction_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.junctionno!=null and dto.junctionno!=''">
                and fjunction_no = #{dto.junctionno}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        )temp
    </select>

    <!-- 查询所有焊机id，编号，组织机构id及名称 -->
    <select id="getAllMachine" resultMap="dataMap">
        SELECT m.fid,m.fequipment_no fname,i.fid insid,i.fname insname FROM tb_welding_machine m
        inner join tb_insframework i on i.fid = m.finsframework_id
        left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent where i.ftype=23
        <if test="item!=null and item!=''">
            and (i.fid=#{item} or ins.fid=#{item} or insf.fid=#{item} or insf.fparent=#{item})
        </if>
    </select>

    <!--查询所有焊工编号，姓名 -->
    <select id="getAllWelder" resultMap="dataMap">
        SELECT w.fid fid,w.fwelder_no serialnumber,w.fname,i.fname insname FROM tb_welder w
        inner join tb_insframework i on w.Fowner=i.fid
        left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="parent!=null and parent!=''">
            and (i.fid=#{parent} or ins.fid=#{parent} or insf.fid=#{parent} or insf.fparent=#{parent})
        </if>
    </select>

    <!-- 查询所有焊缝编号，组织机构名称 -->
    <select id="getAllJunction" resultMap="dataMap">
        <!--        SELECT fwelded_junction_no serialnumber,j.fexternal_diameter speed,i.fid,i.fname-->
        <!--        FROM tb_welded_junction j-->
        <!--        LEFT JOIN tb_insframework i on i.fid = j.fitemId-->
        <!--        where 1=1-->
        <!--        <if test="junctionno!=null and junctionno!=''">-->
        <!--            and fwelded_junction_no like #{junctionno}-->
        <!--        </if>-->
        SELECT fid fid,junction_name fvaluename FROM tb_junction
        WHERE 1=1
        <if test="junctionno!=null and junctionno!=''">
            and ${junctionno}
        </if>
    </select>

    <!-- 查询所有项目部组织机构 -->
    <select id="getAllInsframe" resultMap="dataMap">
        SELECT i.fid,i.fname FROM tb_insframework i
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1 = 1
        <!-- i.ftype=23 -->
        <if test="parent!=null and parent!=''">
            and (i.fid=#{parent} or ins.fid=#{parent} or insf.fid=#{parent} or insf.fparent=#{parent})
        </if>
    </select>

    <!-- 查询组织机构正常焊接时长 -->
    <select id="getWeldItemInCount" resultMap="dataMap">
        select fname,sum(insid) insid,sum(hour) worktime from(
        select j.fid,j.fname, 0 insid, 0 hour from tb_insframework j
        LEFT JOIN tb_insframework ins on ins.fid = j.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent WHERE j.ftype=23
        <if test="dto!=null and dto!=''">
            <if test="dto.parent!=null and dto.parent!=''">
                and (j.fid=#{dto.parent} or ins.fid=#{dto.parent} or insf.fid=#{dto.parent} or
                insf.fparent=#{dto.parent})
            </if>
        </if>
        union all
        SELECT j.fid, j.fname insname,SUM(a.fworktime) insid, 0 hour FROM tb_insframework j
        INNER JOIN tb_work a ON j.fid=a.fmachine_itemid
        LEFT JOIN tb_insframework ins on ins.fid = j.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent WHERE j.ftype=23
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and a.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and a.fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.parent!=null and dto.parent!=''">
                and (j.fid=#{dto.parent} or ins.fid=#{dto.parent} or insf.fid=#{dto.parent} or
                insf.fparent=#{dto.parent})
            </if>
        </if>
        GROUP BY j.fid, j.fname
        UNION ALL
        SELECT j.fid, j.fname insname, 0 insid,SUM(a.fworktime) hour FROM tb_insframework j
        INNER JOIN tb_work a ON j.fid=a.fmachine_itemid
        LEFT JOIN tb_insframework ins on ins.fid = j.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent WHERE j.ftype=23 and a.fstatus=99
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and a.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and a.fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.parent!=null and dto.parent!=''">
                and (j.fid=#{dto.parent} or ins.fid=#{dto.parent} or insf.fid=#{dto.parent} or
                insf.fparent=#{dto.parent})
            </if>
        </if>
        GROUP BY j.fid, j.fname
        )temp group by fname order by fname
    </select>

    <!-- 查询组织机构超规范焊接时长 -->
    <select id="getWeldItemOutCount" resultMap="dataMap">
        select * from (
        select i.fid,i.fname,SUM(w.falarmtime) insid from tb_insframework i
        inner join tb_alarm w on w.fmachine_itemid=i.fid
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent
        where i.ftype=23
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and w.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and w.fstarttime &lt; to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.parent!=null and dto.parent!=''">
                and (i.fid=#{dto.parent} or ins.fid=#{dto.parent} or insf.fid=#{dto.parent} or
                insf.fparent=#{dto.parent})
            </if>
        </if>
        group by i.fid,i.fname
        UNION ALL
        select i.fid,i.fname,0 insid from tb_insframework i
        inner JOIN tb_insframework ins on ins.fid = i.fparent
        inner JOIN tb_insframework insf on insf.fid = ins.fparent
        where i.ftype=23
        <if test="dto!=null and dto!=''">
            <if test="dto.parent!=null and dto.parent!=''">
                and (i.fid=#{dto.parent} or ins.fid=#{dto.parent} or insf.fid=#{dto.parent} or
                insf.fparent=#{dto.parent})
            </if>
        </if>
        and i.fid not in
        (select i.fid from tb_insframework i
        inner join tb_alarm w on w.fmachine_itemid=i.fid
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent
        where i.ftype=23
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and w.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and w.fstarttime &lt; to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.parent!=null and dto.parent!=''">
                and (i.fid=#{dto.parent} or ins.fid=#{dto.parent} or insf.fid=#{dto.parent} or
                insf.fparent=#{dto.parent})
            </if>
        </if>
        group by i.fid )
        )temp
    </select>

    <!-- 查询焊机正常焊接时长 -->
    <select id="getWeldMachineInCount" resultMap="dataMap">
        select fequipment_no insname,fname,sum(insid) insid,sum(hour) worktime from(
        select j.fid,j.fequipment_no,i.fname, 0 insid, 0 hour from tb_welding_machine j
        INNER JOIN tb_insframework i on i.fid = j.finsframework_id
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent WHERE 1=1
        <if test="dto!=null and dto!=''">
            <if test="itemid!=null and itemid!=''">
                and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
            </if>
        </if>
        union all
        SELECT j.fid, j.fequipment_no,i.fname,SUM(a.fworktime) insid, 0 hour
        FROM tb_welding_machine j
        INNER JOIN tb_work a ON j.fid=a.fmachine_id
        INNER JOIN tb_insframework i on i.fid = j.finsframework_id
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent WHERE 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and a.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and a.fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="itemid!=null and itemid!=''">
                and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
            </if>
        </if>
        GROUP BY j.fid,j.fequipment_no,i.fname
        UNION ALL
        SELECT j.fid, j.fequipment_no,i.fname, 0 insid,SUM(a.fworktime) hour
        FROM tb_welding_machine j
        INNER JOIN tb_work a ON j.fid=a.fmachine_id
        INNER JOIN tb_insframework i on i.fid = j.finsframework_id
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent WHERE 1=1 and a.fstatus=99
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and a.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and a.fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="itemid!=null and itemid!=''">
                and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
            </if>
        </if>
        GROUP BY j.fid, j.fequipment_no,i.fname
        )temp group by fid,fequipment_no,fname order by fid
    </select>

    <!-- 查询焊机超规范焊接时长 -->
    <select id="getWeldMachineOutCount" resultMap="dataMap">
        select * from (
        SELECT m.fequipment_no fname,i.fname insname,SUM(w.falarmtime) insid FROM tb_welding_machine m
        inner join tb_insframework i on i.fid = m.finsframework_id
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent
        INNER JOIN tb_alarm w ON w.fmachine_id=m.fid
        where 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and w.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and w.fstarttime &lt; to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        GROUP BY m.fid
        UNION ALL
        SELECT m.fequipment_no fname,i.fname insname,0 insid FROM tb_welding_machine m
        inner join tb_insframework i on i.fid = m.finsframework_id
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent where 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        and m.fid NOT IN (SELECT m.fid FROM tb_welding_machine m
        inner join tb_insframework i on i.fid = m.finsframework_id
        INNER JOIN tb_alarm w ON w.fmachine_id=m.fid where 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and w.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and w.fstarttime &lt; to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        GROUP BY m.fid )
        )temp
    </select>

    <!-- 查询焊工正常焊接时长 parameterType="com.shth.spacexifa.dto.WeldDto"-->
    <select id="getWeldPersonInCount" resultMap="dataMap">
        select insname,fname,sum(insid) insid,sum(hour) worktime from (
        select j.fid,j.fwelder_no insname,j.fname, 0 insid, 0 hour from tb_welder j
        INNER JOIN tb_insframework i on i.fid = j.Fowner
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent WHERE 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.parent!=null and dto.parent!=''">
                and (i.fid=#{dto.parent} or ins.fid=#{dto.parent} or insf.fid=#{dto.parent} or
                insf.fparent=#{dto.parent})
            </if>
        </if>
        union all
        SELECT j.fid, j.fwelder_no insname,j.fname,SUM(a.fworktime) insid, 0 hour FROM tb_welder j
        INNER JOIN tb_work a ON j.fid=a.fwelder_id
        INNER JOIN tb_insframework i on i.fid = j.Fowner
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent WHERE 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and a.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and a.fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.parent!=null and dto.parent!=''">
                and (i.fid=#{dto.parent} or ins.fid=#{dto.parent} or insf.fid=#{dto.parent} or
                insf.fparent=#{dto.parent})
            </if>
        </if>
        GROUP BY j.fid,j.fwelder_no,j.fname
        UNION ALL
        SELECT j.fid, j.fwelder_no insname,j.fname, 0 insid,SUM(a.fworktime) hour FROM tb_welder j
        INNER JOIN tb_work a ON j.fid=a.fwelder_id
        INNER JOIN tb_insframework i on i.fid = j.Fowner
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent WHERE 1=1 and a.fstatus=99
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and a.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and a.fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.parent!=null and dto.parent!=''">
                and (i.fid=#{dto.parent} or ins.fid=#{dto.parent} or insf.fid=#{dto.parent} or
                insf.fparent=#{dto.parent})
            </if>
        </if>
        GROUP BY j.fid,j.fwelder_no,j.fname
        )temp
        group by fid,insname,fname order by fid
    </select>

    <!-- 查询焊工超规范焊接时长 -->
    <select id="getWeldPersonOutCount" resultMap="dataMap">
        select * from
        ( SELECT w.fwelder_no insname,w.fname,SUM(a.falarmtime) insid FROM tb_welder w
        inner join tb_alarm a on a.fwelder_id=w.fid
        inner join tb_insframework i on i.fid = w.Fowner
        left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and a.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and a.fstarttime &lt; to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.parent!=null and dto.parent!=''">
                and (i.fid=#{dto.parent} or ins.fid=#{dto.parent} or insf.fid=#{dto.parent} or
                insf.fparent=#{dto.parent})
            </if>
        </if>
        GROUP BY w.fid
        UNION ALL
        SELECT w.fwelder_no insname,w.fname,0 insid FROM tb_welder w
        inner join tb_insframework i on i.fid = w.Fowner
        left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.parent!=null and dto.parent!=''">
                and (i.fid=#{dto.parent} or ins.fid=#{dto.parent} or insf.fid=#{dto.parent} or
                insf.fparent=#{dto.parent})
            </if>
        </if>
        and w.fid NOT IN (
        SELECT w.fid FROM tb_welder w
        inner join tb_alarm a on a.fwelder_id=w.fid
        inner join tb_insframework i on i.fid = w.Fowner
        left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and a.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and a.fstarttime &lt; to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.parent!=null and dto.parent!=''">
                and (i.fid=#{dto.parent} or ins.fid=#{dto.parent} or insf.fid=#{dto.parent} or
                insf.fparent=#{dto.parent})
            </if>
        </if>
        GROUP BY w.fid )
        )temp
    </select>

    <!-- 查询工件正常焊接时长 -->
    <select id="getWeldPieceInCount" resultMap="dataMap">
        select junction_name insname,sum(insid) insid,sum(hour) worktime from(
            select j.fid,j.JUNCTION_NAME, 0 insid, 0 hour from tb_junction j
            WHERE 1=1
            <if test="junctionno!=null and junctionno!=''">
                and j.JUNCTION_NAME like #{junctionno}
            </if>
            union all
            SELECT j.fid, j.JUNCTION_NAME,SUM(a.fworktime) insid, 0 hour
            FROM tb_junction j
            INNER JOIN tb_work a ON j.fid=a.fjunction_id
            WHERE 1=1
            <if test="dto!=null and dto!=''">
                <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                    and a.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
                </if>
                <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                    and a.fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
                </if>
                <if test="dto.bloc!=null and dto.bloc!=''">
                    and a.FPRODUCT_NUMBER_ID = #{dto.bloc}
                </if>
            </if>
            <if test="junctionno!=null and junctionno!=''">
                and j.JUNCTION_NAME like #{junctionno}
            </if>
            GROUP BY j.fid, j.JUNCTION_NAME
            UNION ALL
            SELECT j.fid, j.JUNCTION_NAME, 0 insid,SUM(a.fworktime) hour
            FROM tb_junction j
            INNER JOIN tb_work a ON j.fid=a.fjunction_id
            LEFT JOIN tb_production_craft p on j.fid = p.fjunction
            LEFT JOIN tb_library_junction l on p.fid = l.production_id
            LEFT JOIN tb_welded_junction e on l.trackingcard_id = e.fid
            WHERE a.fstatus=99
            <if test="dto!=null and dto!=''">
                <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                    and a.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
                </if>
                <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                    and a.fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
                </if>
                <if test="dto.bloc!=null and dto.bloc!=''">
                    and a.FPRODUCT_NUMBER_ID = #{dto.bloc}
                </if>
            </if>
            <if test="junctionno!=null and junctionno!=''">
                and j.JUNCTION_NAME like #{junctionno}
            </if>
            GROUP BY j.fid, j.JUNCTION_NAME
        )temp group by fid,JUNCTION_NAME,insid order by fid
    </select>

    <!-- 查询工件超规范焊接时长 -->
    <select id="getWeldPieceOutCount" resultMap="dataMap">
        select * from (
        SELECT j.fwelded_junction_no insname,SUM(a.falarmtime) insid FROM tb_welded_junction j
        INNER JOIN tb_alarm a ON j.fid=a.fjunction_id
        INNER JOIN tb_insframework i on i.fid = j.fitemId
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent WHERE 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and a.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and a.fstarttime &lt; to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.parent!=null and dto.parent!=''">
                and (i.fid=#{dto.parent} or ins.fid=#{dto.parent} or insf.fid=#{dto.parent} or
                insf.fparent=#{dto.parent})
            </if>
        </if>
        <if test="junctionno!=null and junctionno!=''">
            and j.fwelded_junction_no like #{junctionno}
        </if>
        GROUP BY j.fid
        UNION ALL
        SELECT j.fwelded_junction_no insname,0 insid FROM tb_welded_junction j
        INNER JOIN tb_insframework i on i.fid = j.fitemId
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent where 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.parent!=null and dto.parent!=''">
                and (i.fid=#{dto.parent} or ins.fid=#{dto.parent} or insf.fid=#{dto.parent} or
                insf.fparent=#{dto.parent})
            </if>
        </if>
        and j.fid NOT IN (
        SELECT fjunction_id FROM tb_alarm l
        INNER JOIN tb_insframework i on i.fid = l.fjunction_itemid
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent WHERE 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fstarttime &lt; to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.parent!=null and dto.parent!=''">
                and (i.fid=#{dto.parent} or ins.fid=#{dto.parent} or insf.fid=#{dto.parent} or
                insf.fparent=#{dto.parent})
            </if>
        </if>
        <if test="junctionno!=null and junctionno!=''">
            and fjunction_no like #{junctionno}
        </if>
        GROUP BY fjunction_id)
        <if test="junctionno!=null and junctionno!=''">
            and j.fwelded_junction_no like #{junctionno}
        </if>
        )temp
    </select>

    <!-- 故障报表 -->
    <select id="getFauit" resultMap="dataMap">
        SELECT m.fid,m.fequipment_no fname,i.fname insname,d.fvaluename,sum(fwarntime) num FROM tb_warn l
        INNER JOIN tb_welding_machine m on m.fid = l.fmachine_id
        INNER JOIN tb_insframework i on i.fid = l.fmachine_itemid
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent
        INNER JOIN tb_dictionary d on d.fvalue = l.fstatus
        where d.ftypeid=15
        <if test="value>0">
            and d.fvalue=#{value}
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.parent!=null and dto.parent!=''">
                and (i.fid=#{dto.parent} or ins.fid=#{dto.parent} or insf.fid=#{dto.parent} or
                insf.fparent=#{dto.parent})
            </if>
        </if>
        group by m.fid,d.fvalue
    </select>

    <!-- 故障报表 -->
    <select id="getFauitDetail" resultMap="dataMap">
        SELECT m.fequipment_no fname,i.fname insname,d.fvaluename,FWeldTime time FROM tb_live_data l
        INNER JOIN tb_welding_machine m ON m.fid = l.fmachine_id
        INNER JOIN tb_insframework i on i.fid = l.fmachine_itemid
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent
        INNER join tb_dictionary d on d.fvalue=l.fstatus
        where d.ftypeid=15
        <if test="id!=null and id!=''">
            and fmachine_id=#{id}
        </if>
        <if test="value>0">
            and d.fvalue=#{value}
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and FWeldTime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and FWeldTime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.parent!=null and dto.parent!=''">
                and (i.fid=#{dto.parent} or ins.fid=#{dto.parent} or insf.fid=#{dto.parent} or
                insf.fparent=#{dto.parent})
            </if>
        </if>
    </select>

    <!-- 焊工工作排行榜(焊接时长) -->
    <select id="getWorkRank" resultMap="dataMap" useCache="true">
        SELECT * FROM (
            SELECT l.fwelder_id,w.FNAME,w.FWELDER_NO welderno,i.fname insname,SUM(fworktime)/3600 hour FROM tb_work l
            INNER JOIN tb_welder w ON l.FWELDER_ID = w.fid
            LEFT JOIN tb_insframework i on i.fid = w.FOWNER
            WHERE 1 = 1
            <if test="time != null and time != ''">
                and l.fstarttime >= to_date(#{time}, 'yyyy-mm-dd')
            </if>
            <if test="parent != null and parent != ''">
                AND i.FPARENT = #{parent}
            </if>
            GROUP BY l.fwelder_id,w.FNAME,w.FWELDER_NO,i.fname
            ORDER BY hour DESC
        ) WHERE 7 >= ROWNUM
    </select>

    <!-- 焊工工作排行榜(待机时长) -->
    <select id="getStandbyRank" resultMap="dataMap" useCache="true">
        SELECT * FROM (
            SELECT s.fwelder_id,w.FNAME,w.FWELDER_NO welderno,i.fname insname,SUM(s.FSTANDBYTIME)/3600 hour FROM TB_STANDBY s
            INNER JOIN tb_welder w ON s.FWELDER_ID = w.fid
            LEFT JOIN tb_insframework i on i.fid = w.FOWNER
            WHERE 1 = 1
            <if test="time != null and time != ''">
                and s.fstarttime >= to_date(#{time}, 'yyyy-mm-dd')
            </if>
            <if test="parent != null and parent != ''">
                AND i.FPARENT = #{parent}
            </if>
            GROUP BY s.fwelder_id,w.FNAME,w.FWELDER_NO,i.fname
            ORDER BY hour DESC
        ) WHERE 7 >= ROWNUM
    </select>

    <select id="findWelderMaterialConsume" parameterType="java.lang.String" resultMap="dataMap">
        SELECT * FROM (
        SELECT wr.FNAME,sum((w.fworktime*w.fwirefeedrate*m.fcoefficient)/60) wirefeedrate
        FROM tb_work w
        LEFT JOIN tb_material_coefficient m ON w.fmaterialgas = m.fmaterial and w.fwirediameter = m.fdiameter and
        w.fmachinemodel=m.fmodel
        INNER JOIN TB_WELDER wr ON wr.FID = w.FWELDER_ID
        WHERE 1=1
        <if test="startTime != null and startTime != ''">
            AND w.FSTARTTIME >= TO_DATE(#{startTime}, 'yyyy-mm-dd')
        </if>
        GROUP BY w.FWELDER_ID,wr.FNAME ORDER BY wirefeedrate DESC
        ) WHERE 7 >= ROWNUM
    </select>

    <!-- 获取工作的焊机数-->
    <select id="getWorkMachineCount" resultMap="dataMap">
        select count(DISTINCT(fmachine_id)) machinenum
        from tb_work w INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid left JOIN tb_insframework ins on
        ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where fmachine_id!=0
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        and fstarttime &gt;= #{time} and fendtime &lt; date_sub(date_sub(#{time},interval -1 day),interval 0 minute)
    </select>

    <!-- 查询组织机构正常焊接时长 -->
    <select id="getItemWeldTime" resultMap="dataMap">
        select * from (select i.fid,i.fname,SUM(fworktime)/60/60 hour,to_char(fstarttime, 'yyyy-MM-dd') time from
        tb_insframework i
        inner join tb_work w on w.fmachine_itemid=i.fid
        where i.ftype=23
        <if test="dto!=null and dto!=''">
            <if test="dto.parent!=null and dto.parent!=''">
                and i.fparent = #{dto.parent}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss') >= fendtime
            </if>
        </if>
        group by i.fid,i.fname,fstarttime
        )temp
    </select>

    <!-- 查询组织机构超规范焊接时长 -->
    <select id="getItemOverProofTime" resultMap="dataMap">
        select * from (
        select i.fid,i.fname,SUM(w.fwarntime)/60/60 hour,to_char(fstarttime,'yyyy-MM-dd') time from tb_insframework i
        inner join tb_warn w on w.fmachine_itemid=i.fid
        where i.ftype=23 and fstatus=99
        <if test="dto!=null and dto!=''">
            <if test="dto.parent!=null and dto.parent!=''">
                and i.fparent = #{dto.parent}
            </if>
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime >= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss') >= fendtime
            </if>
        </if>
        group by i.fid,i.fname,fstarttime
        )temp
    </select>

    <select id="findLoadRateList" resultMap="dataMap">
        <if test="itemType == 22">
            SELECT i.fid,i.fname,sum(t.wkhour) wkhour,sum(t.wnhour) wnhour FROM tb_insframework i
            INNER JOIN(
            SELECT i.fid,i.fname,sum(wk.fworktime)/3600 wkhour,sum(wn.FALARMTIME)/3600 wnhour,i.FPARENT
            FROM tb_insframework i LEFT JOIN tb_work wk ON wk.fmachine_itemid=i.fid
            <if test="startTime != null and startTime != ''">
                AND wk.FSTARTTIME >= TO_DATE(#{startTime}, 'yyyy-mm-dd')
            </if>
            LEFT JOIN TB_ALARM wn on wn.fmachine_itemid=i.fid
            <if test="startTime != null and startTime != ''">
                AND wn.FSTARTTIME >= TO_DATE(#{startTime}, 'yyyy-mm-dd')
            </if>
            WHERE i.FTYPE = 23
            GROUP BY i.fid,i.fname,i.FPARENT ORDER BY FID
            )t ON t.FPARENT = i.fid
            WHERE i.FTYPE = 22 GROUP BY i.fid,i.fname ORDER BY FID
        </if>
        <if test="itemType == 23">
            SELECT i.fid,i.fname,sum(wk.fworktime)/3600 wkhour,sum(wn.FALARMTIME)/3600 wnhour
            FROM tb_insframework i LEFT JOIN tb_work wk ON wk.fmachine_itemid=i.fid
            <if test="startTime != null and startTime != ''">
                AND wk.FSTARTTIME >= TO_DATE(#{startTime}, 'yyyy-mm-dd')
            </if>
            LEFT JOIN TB_ALARM wn on wn.fmachine_itemid=i.fid
            <if test="startTime != null and startTime != ''">
                AND wn.FSTARTTIME >= TO_DATE(#{startTime}, 'yyyy-mm-dd')
            </if>
            WHERE i.FTYPE = 23
            GROUP BY i.fid,i.fname ORDER BY FID
        </if>
    </select>

    <select id="getWireMatral" resultMap="dataMap">
        <if test="itemType == 22">
            SELECT i.fid,i.fname,sum(t.wirefeedrate) wirefeedrate FROM tb_insframework i
            INNER JOIN(
            SELECT i.fid,i.fname,sum(w.fworktime)
            worktime,i.FPARENT,sum((w.fworktime*w.fwirefeedrate*m.fcoefficient)/60) wirefeedrate FROM tb_insframework i
            LEFT JOIN tb_work w ON w.fmachine_itemid=i.fid
            LEFT JOIN tb_material_coefficient m on w.fmaterialgas = m.fmaterial and w.fwirediameter = m.fdiameter and
            w.fmachinemodel=m.fmodel
            WHERE i.FTYPE = 23
            <if test="time1 != null and time1 != ''">
                AND w.FSTARTTIME >= TO_DATE(#{time1}, 'yyyy-mm-dd')
            </if>
            GROUP BY i.fid,i.fname,i.FPARENT ORDER BY i.fid
            )t ON t.FPARENT = i.fid
            WHERE i.FTYPE = 22 GROUP BY i.fid,i.fname ORDER BY wirefeedrate desc
        </if>
        <if test="itemType == 23">
            SELECT i.fid,i.fname,sum(w.fworktime)
            worktime,i.FPARENT,sum((w.fworktime*w.fwirefeedrate*m.fcoefficient)/60) wirefeedrate FROM tb_insframework i
            LEFT JOIN tb_work w ON w.fmachine_itemid=i.fid
            LEFT JOIN tb_material_coefficient m on w.fmaterialgas = m.fmaterial and w.fwirediameter = m.fdiameter and
            w.fmachinemodel=m.fmodel
            WHERE i.FTYPE = 23
            <if test="time1 != null and time1 != ''">
                AND w.FSTARTTIME >= TO_DATE(#{time1}, 'yyyy-mm-dd')
            </if>
            GROUP BY i.fid,i.fname,i.FPARENT ORDER BY i.fid
        </if>
    </select>

    <!-- 组织机构分组，查询人均工作时间（焊接工作时间） -->
    <select id="findAverageWorkingTime" resultMap="dataMap">
        <if test="itemType == 22">
            SELECT i.fid,i.fname,i.FTYPE type,sum(t.wkhour) hour,sum(t.num) num FROM tb_insframework i
            INNER JOIN(
            SELECT i.fid,i.fname,sum(wk.fworktime)/3600 wkhour,i.FPARENT,COUNT(DISTINCT wr.FOWNER) num
            FROM tb_insframework i
            LEFT JOIN tb_work wk ON wk.FWELDER_ITEMID=i.fid
            <if test="startTime != null and startTime != ''">
                AND wk.FSTARTTIME >= TO_DATE(#{startTime}, 'yyyy-mm-dd')
            </if>
            LEFT JOIN TB_WELDER wr ON i.fid = wr.FOWNER
            WHERE i.FTYPE = 23
            GROUP BY i.fid,i.fname,i.FPARENT ORDER BY FID
            )t ON t.FPARENT = i.fid
            WHERE i.FTYPE = 22 GROUP BY i.fid,i.fname,i.FTYPE ORDER BY FID
        </if>
        <if test="itemType == 23">
            SELECT i.fid,i.fname,i.FTYPE type,i.FPARENT,sum(wk.fworktime)/3600 hour,COUNT(DISTINCT wr.FOWNER) num
            FROM tb_insframework i
            LEFT JOIN tb_work wk ON wk.FWELDER_ITEMID=i.fid
            <if test="startTime != null and startTime != ''">
                AND wk.FSTARTTIME >= TO_DATE(#{startTime}, 'yyyy-mm-dd')
            </if>
            LEFT JOIN TB_WELDER wr ON i.fid = wr.FOWNER
            WHERE i.FTYPE = 23
            GROUP BY i.fid,i.fname,i.FTYPE,i.FPARENT ORDER BY FID
        </if>
    </select>

    <!-- 组织机构分组，查询人均工作时间（待机工作时间） -->
    <select id="findStandbyWorkingTime" resultMap="dataMap">
        <if test="itemType == 22">
            SELECT i.fid,i.fname,i.FTYPE type,sum(t.wkhour) hour,sum(t.num) num FROM tb_insframework i
            INNER JOIN(
            SELECT i.fid,i.fname,sum(sdb.FSTANDBYTIME)/3600 wkhour,i.FPARENT,COUNT(DISTINCT wr.FOWNER) num
            FROM tb_insframework i
            LEFT JOIN TB_STANDBY sdb ON sdb.FWELDER_ITEMID=i.fid
            <if test="startTime != null and startTime != ''">
                AND sdb.FSTARTTIME >= TO_DATE(#{startTime}, 'yyyy-mm-dd')
            </if>
            LEFT JOIN TB_WELDER wr ON i.fid = wr.FOWNER
            WHERE i.FTYPE = 23
            GROUP BY i.fid,i.fname,i.FPARENT ORDER BY FID
            )t ON t.FPARENT = i.fid
            WHERE i.FTYPE = 22 GROUP BY i.fid,i.fname,i.FTYPE ORDER BY FID
        </if>
        <if test="itemType == 23">
            SELECT i.fid,i.fname,i.FTYPE type,i.FPARENT,sum(sdb.FSTANDBYTIME)/3600 hour,COUNT(DISTINCT wr.FOWNER) num
            FROM tb_insframework i
            LEFT JOIN TB_STANDBY sdb ON sdb.FWELDER_ITEMID=i.fid
            <if test="startTime != null and startTime != ''">
                AND sdb.FSTARTTIME >= TO_DATE(#{startTime}, 'yyyy-mm-dd')
            </if>
            LEFT JOIN TB_WELDER wr ON i.fid = wr.FOWNER
            WHERE i.FTYPE = 23
            GROUP BY i.fid,i.fname,i.FTYPE,i.FPARENT ORDER BY FID
        </if>
    </select>

    <select id="getWireAndFlow" resultMap="dataMap">
        SELECT fname,sum(weldwire) weldwire,sum(gas) gas from (
        select j.fname, 0 weldwire, 0 gas from tb_insframework j
        LEFT JOIN tb_insframework ins on ins.fid = j.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent WHERE j.ftype=23
        <if test="itemid!=null and itemid!=''">
            and (j.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        union all
        select i.fname, sum((w.fworktime*w.fwirefeedrate*DECODE(m.fcoefficient, NULL, 0 ,m.fcoefficient))/60)
        weldwire,sum((w.fworktime*w.frateofflow)/60) gas from tb_work w
        INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid
        left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        left JOIN tb_material_coefficient m on w.fmaterialgas = m.fmaterial and w.fwirediameter = m.fdiameter and
        w.fmachinemodel=m.fmodel
        where 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        group BY i.fname
        ) t group BY fname
    </select>

    <select id="getEquipmentUtilize" resultMap="dataMap">
        select count(DISTINCT(fmachine_id)) num,count(DISTINCT(machine)) total,count(DISTINCT(fid)) fid from(
        select null fmachine_id,null machine,w.fid from tb_welding_machine w
        INNER JOIN tb_insframework i on i.fid = w.finsframework_id left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        union all
        select fmachine_id,fmachine_id machine,null fid from tb_work w
        INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where fmachine_id!=0
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and w.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        UNION all
        select fmachine_id,null machine,null fid from tb_standby w
        INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where fmachine_id!=0
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and w.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        UNION all
        select fmachine_id,fmachine_id machine,null fid from tb_warn w
        INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where fmachine_id!=0
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and w.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        )temp
    </select>

    <select id="getOnAndWeldTime" resultMap="dataMap">
        select fid,fname,sum(insid) insid,sum(hour) worktime from(
        select j.fid,j.fname, 0 insid, 0 hour from tb_insframework j
        LEFT JOIN tb_insframework ins on ins.fid = j.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent WHERE j.ftype=23
        <if test="itemid!=null and itemid!=''">
            and (j.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        union all
        SELECT j.fid, j.fname insname,SUM(a.fworktime) insid, SUM(a.fworktime) hour FROM tb_insframework j
        INNER JOIN tb_work a ON j.fid=a.fmachine_itemid
        LEFT JOIN tb_insframework ins on ins.fid = j.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent WHERE 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and a.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        <if test="itemid!=null and itemid!=''">
            and (j.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        GROUP BY j.fid,j.fname
        UNION ALL
        SELECT j.fid, j.fname insname, SUM(a.fwarntime) insid,SUM(a.fwarntime) hour FROM tb_insframework j
        INNER JOIN tb_warn a ON j.fid=a.fmachine_itemid
        LEFT JOIN tb_insframework ins on ins.fid = j.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent WHERE 1=1 and a.fstatus !='99'
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and a.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        <if test="itemid!=null and itemid!=''">
            and (j.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        GROUP BY j.fid,j.fname
        UNION ALL
        SELECT j.fid, j.fname insname, SUM(a.fstandbytime) insid,0 hour FROM tb_insframework j
        INNER JOIN tb_standby a ON j.fid=a.fmachine_itemid
        LEFT JOIN tb_insframework ins on ins.fid = j.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent WHERE 1=1
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and a.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        <if test="itemid!=null and itemid!=''">
            and (j.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        GROUP BY j.fid,j.fname
        )temp group by fid,fname order by fid,fname
    </select>

    <select id="getMachineTask" resultMap="dataMap">
        select * from (
        SELECT wt.weldTime time,i.fid insid,i.fname insname,m.fid,m.fequipment_no machineno,fwelded_junction_no taskno,
        t.weldtime starttime,CASE WHEN fwelded_junction_no IS null THEN 1 ELSE 2 END AS type FROM (
        ${sql}
        ) wt left JOIN tb_welding_machine m on 1=1 left JOIN tb_insframework i on i.fid = m.finsframework_id
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent LEFT JOIN tb_insframework insf on insf.fid = ins.fparent
        left JOIN (
        SELECT m.fid,m.fequipment_no,j.fwelded_junction_no,DATE_FORMAT( t.frealstarttime, '%Y-%m-%d') weldtime
        FROM tb_welding_machine m INNER JOIN tb_taskresult t on t.fmachineid = m.fid
        INNER JOIN tb_welded_junction j on j.fid = t.ftaskid group by m.fid,weldtime) t
        on t.fid = m.fid and t.weldtime = wt.weldtime where 1=1
        <if test="parent!=null and parent!=''">
            and (i.fid=#{parent} or ins.fid=#{parent} or insf.fid=#{parent} or insf.fparent=#{parent})
        </if>
        )temp where 1=1
        <if test="type!=0">
            and type = #{type}
        </if>
        order by fid,time,type
    </select>

    <select id="getMachineNoTask" resultMap="dataMap">
        SELECT DISTINCT k.FMACHINE_ID fmachineid,k.fname,k.fid from (
        SELECT distinct l.FMACHINE_ID,l.fweld_no fname,i.fid FROM tb_live_data l
        INNER JOIN tb_insframework i on i.fid = l.fmachine_itemid
        left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        WHERE 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="totime!=null and totime!=''">
            <!--and l.FWeldTime &gt;= #{totime}-->
            and l.FWeldTime >= to_date(#{totime},'yyyy-mm-dd hh24:mi:ss')
        </if>
        <if test="time2!=null and time2!=''">
            <!--and l.FWeldTime &lt;= #{time2}-->
            and to_date(#{time2},'yyyy-mm-dd hh24:mi:ss') >= l.FWeldTime
        </if>
        union all
        SELECT distinct l.FMACHINE_ID,l.fweld_no fname,i.fid FROM tb_work l
        INNER JOIN tb_insframework i on i.fid = l.fmachine_itemid
        left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        WHERE 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="time1!=null and time1!=''">
            <!--and l.fstarttime &gt;= #{time1}-->
            and l.fstarttime >= to_date(#{time1},'yyyy-mm-dd hh24:mi:ss')
        </if>
        <if test="totime!=null and totime!=''">
            <!--and l.fendtime &lt;= #{totime}-->
            and to_date(#{time1},'yyyy-mm-dd hh24:mi:ss') >= l.fendtime
        </if>
        ) k where k.FMACHINE_ID NOT IN
        (SELECT DISTINCT t.fmachineid FROM tb_taskresult t
        WHERE 1=1
        <if test="time1!=null and time1!=''">
            <!--and t.frealstarttime &gt;= #{time1}-->
            and t.frealstarttime &gt;= to_date(#{time1},'yyyy-mm-dd hh24:mi:ss')
        </if>
        <if test="time2!=null and time2!=''">
            <!--and t.frealstarttime &lt;= #{time2}-->
            and t.frealstarttime &lt;= to_date(#{time2},'yyyy-mm-dd hh24:mi:ss')
        </if>
        )
    </select>

    <select id="getWarnTimes" resultMap="dataMap">
        SELECT * from (
        select sum(w.fwarntime) total,i.fname,i.ftype from tb_warn w
        INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and w.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        GROUP BY w.fmachine_itemid
        union all
        SELECT 0 total,i.fname,i.ftype FROM tb_insframework i
        left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        and i.fid not in (SELECT DISTINCT fmachine_itemid from tb_warn w INNER JOIN tb_insframework i on i.fid =
        w.fmachine_itemid left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where 1=1
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and w.fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        )) t where t.ftype=23 ORDER BY t.total desc
    </select>

    <select id="getTaskDetails" resultMap="dataMap">
        select fname,sum(insid) insid,sum(hour) worktime from(
        SELECT i.fid,i.fname, 0 insid, 0 hour from tb_insframework i
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent WHERE i.ftype=23
        UNION ALL
        SELECT i.fid,i.fname,COUNT(j.fid) insid,0 hour FROM tb_insframework i
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent
        LEFT JOIN tb_welded_junction j ON i.fid=j.fitemId
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                WHERE fstart_time &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        GROUP BY i.fid,i.fname
        UNION ALL
        SELECT i.fid,i.fname,0 insid,COUNT(t.fid) hour FROM tb_insframework i
        LEFT JOIN tb_insframework ins on ins.fid = i.fparent
        LEFT JOIN tb_insframework insf on insf.fid = ins.fparent
        LEFT JOIN tb_welded_junction j ON i.fid=j.fitemId
        LEFT JOIN tb_taskresult t ON (j.fid=t.ftaskid AND t.foperatetype=1)
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                WHERE fstart_time &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        GROUP BY i.fid,i.fname
        )temp group by fname order by fname
    </select>

    <select id="getHistoryData" resultMap="dataMap">
        SELECT ${filed} name,l.FWeldTime time FROM tb_live_data l WHERE (fstatus='3' or fstatus='5' or fstatus='7' or
        fstatus='99')
        <if test="str!=null and str!=''">
            ${str}
        </if>
        ORDER BY l.FWELDTIME
    </select>

    <select id="getMachineData" resultMap="dataMap" parameterType="com.shth.spacexifa.dto.WeldDto">
        SELECT max(t.name) name,t.machineno machineno, sum(weldwire) weldwire,sum(gas) gas,sum(t.id) id,sum(t.insid)
        insid from (
        select max(i.fname) name,max(w.fweld_no) machineno,sum((w.fworktime*w.fwirefeedrate*DECODE(m.fcoefficient, NULL,
        0 ,m.fcoefficient))/60) weldwire,
        sum((w.fworktime)/60) gas,sum(fworktime)/COUNT(DISTINCT w.FGATHER_NO) id,0 insid from tb_work w
        INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid
        left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        left JOIN tb_material_coefficient m on w.fmaterialgas = m.fmaterial and w.fwirediameter = m.fdiameter and
        w.fmachinemodel=m.fmodel
        where fmachine_id!=0
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        GROUP BY fmachine_id
        UNION
        select max(i.fname) name,max(w.fweld_no) machineno,0 weldwire,0 gas,0 id,sum(fstandbytime)/COUNT(DISTINCT
        w.FGATHER_NO) insid from tb_standby w
        INNER JOIN tb_insframework i on i.fid = w.fmachine_itemid
        left JOIN tb_insframework ins on ins.fid = i.fparent
        left JOIN tb_insframework insf on insf.fid = ins.fparent
        where fmachine_id!=0
        <if test="itemid!=null and itemid!=''">
            and (i.fid=#{itemid} or ins.fid=#{itemid} or insf.fid=#{itemid} or insf.fparent=#{itemid})
        </if>
        <if test="dto!=null and dto!=''">
            <if test="dto.dtoTime1!=null and dto.dtoTime1!=''">
                and fstarttime &gt;= to_date(#{dto.dtoTime1}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="dto.dtoTime2!=null and dto.dtoTime2!=''">
                and fendtime &lt;= to_date(#{dto.dtoTime2}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
        </if>
        GROUP BY fmachine_id
        ) t GROUP BY t.machineno
    </select>

    <!-- 查询超规范信息 -->
    <select id="findSupergageInfo" resultMap="dataMap" parameterType="java.lang.String">
        SELECT a.FSTARTTIME frealstarttime,w.FNAME,i.FNAME insname,wj.JOB_NUMBER,wj.SET_NUMBER,wj.PART_NAME
        FROM TB_ALARM a
        INNER JOIN TB_WELDER w ON a.FWELDER_ID = w.FID
        INNER JOIN TB_INSFRAMEWORK i ON w.FOWNER = i.FID
        INNER JOIN TB_WELDED_JUNCTION wj ON a.FCARD_ID = wj.FID
        WHERE wj.FSTATUS = 1
        <if test="startTime != null and startTime != ''">
            AND a.FSTARTTIME >= TO_DATE(#{startTime}, 'yyyy-mm-dd')
        </if>
        ORDER BY a.FSTARTTIME
    </select>

    <!-- 查询超规范累计次数 -->
    <select id="findSupergageCumulativeNumber" resultMap="dataMap">
        <if test="itemType == 22">
            SELECT i.fid,i.fname,sum(t.num) num FROM tb_insframework i
            INNER JOIN(
            SELECT i.FID,i.FNAME,COUNT(a.FWELDER_ID) num,i.FPARENT FROM TB_INSFRAMEWORK i
            LEFT JOIN TB_WELDER w ON w.FOWNER = i.FID
            LEFT JOIN TB_ALARM a ON w.FID = a.FWELDER_ID
            <if test="startTime != null and startTime != ''">
                AND a.fstarttime >= TO_DATE(#{startTime}, 'yyyy-mm-dd')
            </if>
            WHERE i.FTYPE = 23
            GROUP BY i.FID,i.FNAME,i.FPARENT
            ORDER BY i.FID
            )t ON t.FPARENT = i.fid
            WHERE i.FTYPE = 22 GROUP BY i.fid,i.fname ORDER BY FID
        </if>
        <if test="itemType == 23">
            SELECT i.FID,i.FNAME,COUNT(a.FWELDER_ID) num FROM TB_INSFRAMEWORK i
            LEFT JOIN TB_WELDER w ON w.FOWNER = i.FID
            LEFT JOIN TB_ALARM a ON w.FID = a.FWELDER_ID
            <if test="startTime != null and startTime != ''">
                AND a.fstarttime >= TO_DATE(#{startTime}, 'yyyy-mm-dd')
            </if>
            WHERE i.FTYPE = 23
            GROUP BY i.FID,i.FNAME
            ORDER BY i.FID
        </if>
    </select>

    <!-- 查询工作号布套号焊接工艺规范符合率 -->
    <select id="findJobSetNormRate" resultMap="dataMap" parameterType="java.lang.String">
        SELECT wj.FID,wj.JOB_NUMBER,wj.SET_NUMBER,PART_NAME,SUM(a.FALARMTIME)/3600 wnhour,SUM(w.FWORKTIME)/3600 wkhour
        FROM TB_WELDED_JUNCTION wj
        LEFT JOIN TB_ALARM a ON wj.FID = a.FCARD_ID
        <if test="startTime != null and startTime != ''">
            AND a.FSTARTTIME >= TO_DATE(#{startTime}, 'yyyy-mm-dd')
        </if>
        LEFT JOIN TB_WORK w ON wj.FID = w.FCARD_ID
        <if test="startTime != null and startTime != ''">
            AND w.FSTARTTIME >= TO_DATE(#{startTime}, 'yyyy-mm-dd')
        </if>
        WHERE wj.FSTATUS = 1
        GROUP BY wj.FID,wj.JOB_NUMBER,wj.SET_NUMBER,PART_NAME
    </select>

    <select id="countWelderNumByIid" resultMap="dataMap">
        SELECT m.FID, m.FNAME, m.NUM, n.NUM total
        FROM (
                 SELECT ins.FID, ins.FNAME, ins.FPARENT, SUM(t.num) num
                 FROM TB_INSFRAMEWORK ins
                          LEFT JOIN (
                     SELECT ins.FID, ins.FNAME, ins.FTYPE, ins.FPARENT, COUNT(w.FOWNER) num
                     FROM TB_INSFRAMEWORK ins
                              LEFT JOIN TB_WELDER w ON ins.FID = w.FOWNER
                     WHERE ins.FTYPE = 22
                        OR ins.FTYPE = 23
                     GROUP BY ins.FID, ins.FNAME, FTYPE, ins.FPARENT
                     ORDER BY ins.FID
                 ) t ON ins.FID = t.FPARENT
                 WHERE ins.FTYPE = 22
                    OR ins.FTYPE = 23
                 GROUP BY ins.FID, ins.FNAME, ins.FPARENT
             ) m
                 LEFT JOIN
             (
                 SELECT ins.FID, ins.FNAME, ins.FPARENT, COUNT(w.FOWNER) num
                 FROM TB_INSFRAMEWORK ins
                          LEFT JOIN TB_WELDER w ON ins.FID = w.FOWNER
                 WHERE ins.FTYPE = 22
                    OR ins.FTYPE = 23
                 GROUP BY ins.FID, ins.FNAME, ins.FPARENT
             ) n ON m.FID = n.FID
        ORDER BY m.FID
    </select>
</mapper>